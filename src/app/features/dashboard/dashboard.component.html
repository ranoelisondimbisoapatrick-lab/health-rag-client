<mat-sidenav-container class="shell">
  <!-- Sidebar -->
  <mat-sidenav
    #drawer
    [mode]="(isHandset$ | async) ? 'over' : 'side'"
    [opened]="!(isHandset$ | async)"
    class="sidenav"
  >
    <div class="side-head">
      <div class="brand">
        <span class="emoji">ü©∫</span>
        <div>
          <div class="brand-title">Health RAG</div>
          <div class="brand-sub">Base de connaissance</div>
        </div>
      </div>
    </div>

    <div class="side-body">
      <form (ngSubmit)="ingest()" class="stack">
        <mat-form-field appearance="outline" class="full">
          <mat-label>Nom du m√©dicament</mat-label>
          <input matInput [(ngModel)]="drugName" name="drugName" placeholder="ex: aspirin" />
        </mat-form-field>

        <button
          mat-raised-button
          color="primary"
          type="submit"
          [disabled]="ragService.isLoading() || !drugName.trim()"
        >
          <mat-icon>download</mat-icon>
          Charger les donn√©es
        </button>

        <mat-card class="status" *ngIf="ragService.ingestStatus()">
          <mat-card-content>{{ ragService.ingestStatus() }}</mat-card-content>
        </mat-card>
      </form>
    </div>
  </mat-sidenav>

  <!-- Main -->
  <mat-sidenav-content class="content">
    <mat-toolbar color="primary" class="toolbar">
      <button mat-icon-button (click)="drawer.toggle()" *ngIf="isHandset$ | async">
        <mat-icon>menu</mat-icon>
      </button>

      <span class="title">Health RAG Assistant</span>

      <span class="spacer"></span>

      <button mat-button (click)="logout()">
        <mat-icon>logout</mat-icon>
        D√©connexion
      </button>
    </mat-toolbar>

    <!-- Chat -->
    <div class="chat">
      <div class="messages">
        <ng-container *ngFor="let msg of ragService.messages(); trackBy: trackMsg">
          <div class="row" [class.me]="msg.sender === 'user'">
            <mat-card class="bubble" [class.me]="msg.sender === 'user'">
              <mat-card-content class="bubble-content">
                <div class="sender" *ngIf="msg.sender !== 'user'">AI Assistant</div>
                <div class="text">{{ msg.text }}</div>
              </mat-card-content>
            </mat-card>
          </div>
        </ng-container>

        <div class="loading" *ngIf="ragService.isLoading()">
          <mat-progress-spinner diameter="22" mode="indeterminate"></mat-progress-spinner>
          <span>R√©flexion...</span>
        </div>
      </div>

      <div class="composer">
        <form (ngSubmit)="ask()" class="composer-form">
          <mat-form-field appearance="outline" class="full">
            <mat-label>Votre question</mat-label>
            <input
              matInput
              [(ngModel)]="question"
              name="question"
              [disabled]="ragService.isLoading()"
              placeholder="Posez une question sur vos donn√©es m√©dicales..."
            />
          </mat-form-field>

          <button
            mat-raised-button
            color="accent"
            type="submit"
            [disabled]="ragService.isLoading() || !question.trim()"
          >
            <mat-icon>send</mat-icon>
            Envoyer
          </button>
        </form>
      </div>
    </div>
  </mat-sidenav-content>
</mat-sidenav-container>
